CREATE OR REPLACE VIEW analytics.macro_indicators_latest AS
WITH ranked_obs AS (SELECT sm.series_id, sm.source_series_id, sm.series_name, sm.frequency, eo.observation_date, eo.value, ROW_NUMBER() OVER (PARTITION BY sm.series_id ORDER BY eo.observation_date DESC) as date_rank, LAG(eo.value, CASE sm.frequency WHEN 'D' THEN 365 WHEN 'W' THEN 52 WHEN 'M' THEN 12 WHEN 'Q' THEN 4 WHEN 'A' THEN 1 ELSE 12 END) OVER (PARTITION BY sm.series_id ORDER BY eo.observation_date) as value_1y_ago FROM metadata.series_metadata sm JOIN timeseries.economic_observations eo ON sm.series_id = eo.series_id WHERE sm.is_active = TRUE)
SELECT source_series_id, series_name, frequency, observation_date as latest_date, value as latest_value, value_1y_ago, CASE WHEN value_1y_ago IS NOT NULL AND value_1y_ago != 0 THEN ROUND(100.0 * (value - value_1y_ago) / value_1y_ago, 2) ELSE NULL END as yoy_growth_pct FROM ranked_obs WHERE date_rank = 1;
